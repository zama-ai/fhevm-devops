name: End-to-End test

on:
  push:
    branches:
      - ci/test-workflow
  workflow_dispatch:
    inputs:
      feature_branch:
        description: 'Feature branch to test (optional)'
        required: false
        default: 'main'

jobs:
  run-everything:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Verify Docker Installation
      run: |
        docker --version
        node --version

    - name: Execute run-everything.sh
      id: run_script
      run: |
        cd ./coprocessor/
        ./scripts/run_everything.sh 2>&1 | tee script_output.log
        echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

    - name: Upload Script Output
      uses: actions/upload-artifact@v4
      with:
        name: script-output
        path: script_output.log
        retention-days: 5

    - name: Check Script Execution Status
      if: steps.run_script.outputs.exit_code != '0'
      run: |
        echo "::error::Script execution failed with exit code ${{ steps.run_script.outputs.exit_code }}"
        exit 1

  post-run:
      runs-on: ubuntu-latest
      needs: run-everything
      steps:
      - name: Download Script Output
        uses: actions/download-artifact@v4
        with:
          name: script-output

      - name: Display Latest Output
        run: |
          echo "===== Script Output ====="
          cat script_output.log