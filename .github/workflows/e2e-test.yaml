name: End-to-End test

on:
  push:
    branches:
      - ci/test-workflow
  workflow_dispatch:
    inputs:
      feature_branch:
        description: 'Feature branch to test (optional)'
        required: false
        default: 'main'

jobs:
  run-everything:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Verify Dependencies Installation
      run: |
        docker --version
        node --version

    - name: Check resources
      run: |
        free -h
        top -bn1 | grep "Cpu(s)"

    - name: Execute run-everything.sh
      id: run_script
      run: |
        cd ./coprocessor/
        ./scripts/run_everything.sh || true
        docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
        docker logs zama-kms-gateway-dev-kms-blockchain-asc-deploy-1
        docker logs zama-kms-gateway-dev-kms-simulator-keygen-1
        docker logs zama-kms-gateway-dev-kms-gateway-1