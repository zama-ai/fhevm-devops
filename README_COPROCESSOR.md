# What does the setup do ?

It provides a way to run a co-processor, gateway and kms (in centralized mode)
using docker compose.

The pre-computed contract and account addresses/private keys are configured
across all the components for this test setup.

# How the repository is organized ?

- The docker compose file for KMS is defined
  [locally](./docker-compose/docker-compose-full.yml).

- Co-processor repository is cloned to work_dir and the Makefile is used for
  bringing up co-processor network.

- Solidity repository is cloned to work_dir and used from source to funding
  test accounts, deploy contracts and run tests.

- User is expected to run gateway from source.

## Prerequisites

- If there is an authentication error coming from docker.
  It maybe be that you're pulling a private image without a token.
  Go to github "Settings/Developer Settings" > "Personal Access Tokens" > "Tokens (classic)" > "Generate new token (classic)".
  The token should have the "read:packages" permission.
  Afterwards, do `docker login ghcr.io` and use your github ID and the token to login.
  Note that this token is saved by docker locally in the clear,
  so it's best to only give it the permissions you need and set the expiration time to 7 days.

### Install Binaries

Make sure you have these binaries installed in your environment:

- [docker](https://docs.docker.com/engine/install)
- [rust](https://www.rust-lang.org/tools/install)
- [protobuf](https://grpc.io/docs/protoc-installation)
- [nodejs v20](https://nodejs.org/en/download/package-manager)

> **NB:** We will wrap all components in docker images to remove these prerequisites in the near future.

## Steps setting up the environment (Part 1/2)

### Threshold KMS

0. Verify the configuration in .env file, most important variable is CENTRALIZED_KMS, set it to  false for threshold KMS.

| CENTRALIZED_KMS | Purpose |
| --- | --- |
| true    | KMS is running in centralized mode, keys are generated by one KMS party and signer is automatically updated (default) |
| false   | KMS is running in threshold mode with 4 MPC nodes, keys are freshly generated and signers are automatically updated |

1. Run the KMS in centralized mode (including the deployment of contracts on    KMS blockchain).

- The different steps are:
  - Running the KMS blockchain with KMS core + KMS connector
  - Deploying the different smart contracts
  - Triggering a key-gen and crs-gen
  - RUnning the gateway (which need a working geth node)

    ```bash
    make run-kms
    ```

    <details>
    <summary> üí° Follow KMS blockchain smart contracts deployment ~ 2 mn </summary>

    ```bash
      docker logs zama-kms-gateway-dev-kms-blockchain-asc-deploy-1 -f  

      Summary of all the addresses:
      IPSC_ETHERMINT_ADDRESS : wasm1wug8sewp6cedgkmrmvhl3lf3tulagm9hnvy8p0rppz9yjw0g4wtqhs9hr8
      IPSC_ETHEREUM_ADDRESS : wasm1qg5ega6dykkxc307y25pecuufrjkxkaggkkxh7nad0vhyhtuhw3sq29c3m
      ASC_DEBUG_ADDRESS : wasm1yyca08xqdgvjz0psg56z67ejh9xms6l436u8y58m82npdqqhmmtqas0cl7
      ASC_ETHERMINT_ADDRESS : wasm1yw4xvtc43me9scqfr2jr2gzvcxd3a9y4eq7gaukreugw2yd2f8tsu3v7ad
      ASC_ETHEREUM_ADDRESS : wasm1cnuw3f076wgdyahssdkd0g3nr96ckq8cwa2mh029fn5mgf2fmcms9ax00l

      +++++++++++++++++++++++++++
      Contracts setups successful
      +++++++++++++++++++++++++++
    ```

    </details>

        <details>
    <summary> üí° Follow key and crs genereation ~ 2 mn </summary>

    This docker container is starting only after the deployment step (above)

    ```bash
      docker logs zama-kms-gateway-dev-kms-simulator-keygen-1 -f

      Summary of all the addresses:
      IPSC_ETHERMINT_ADDRESS : wasm1wug8sewp6cedgkmrmvhl3lf3tulagm9hnvy8p0rppz9yjw0g4wtqhs9hr8
      IPSC_ETHEREUM_ADDRESS : wasm1qg5ega6dykkxc307y25pecuufrjkxkaggkkxh7nad0vhyhtuhw3sq29c3m
      ASC_DEBUG_ADDRESS : wasm1yyca08xqdgvjz0psg56z67ejh9xms6l436u8y58m82npdqqhmmtqas0cl7
      ASC_ETHERMINT_ADDRESS : wasm1yw4xvtc43me9scqfr2jr2gzvcxd3a9y4eq7gaukreugw2yd2f8tsu3v7ad
      ASC_ETHEREUM_ADDRESS : wasm1cnuw3f076wgdyahssdkd0g3nr96ckq8cwa2mh029fn5mgf2fmcms9ax00l

      +++++++++++++++++++++++++++
      Contracts setups successful
      +++++++++++++++++++++++++++
    ```

    </details>

2. Go to `kms-core`, checkout `v0.9.0-rc25` and run the `key-gen` and `crs-gen`:
  
    ```
    git checkout v0.9.0-rc25
    cd blockchain/simulator
    cargo run --bin simulator -- --max-iter 50 -f config/local_threshold.toml insecure-key-gen
    ```

    You should see the public key material here: [http://localhost:9001/browser/kms](http://localhost:9001/browser/kms)

    Now, run the CRS generation:

    ```
    cargo run --bin simulator -- --max-iter 200 -f config/local_threshold.toml crs-gen --max-num-bits 2048
    ```

    <details>
    <summary> üí° Check CRS generation status as it may take ~ 20 mn </summary>
  
    ```bash
    docker logs zama-kms-threshold-dev-kms-connector-1-1 > log_connector.txt 2>&1  &&  grep crsgen log_connector.txt -i
    ```

    ```bash
    2024-11-07T14:13:09.775076Z  INFO kms_blockchain_connector::application::kms_core_sync: Running KMS operation with value: CrsGen(CrsGenValues { max_num_bits: 2048, eip712_name: "eip712_name", eip712_version: "1.0.4", eip712_chain_id: HexVector([42, 0, 0... 0, 0, 0, 0, 0, 0, 0, 0]), eip712_verifying_contract: "0x00dA6BF26964af9D7EED9e03E53415d37aa960EE", eip712_salt: Some(HexVector([0, 1, 2, 3, , 31])) })
        2024-11-07T14:41:09.871344Z  INFO kms_blockchain_connector::application::kms_core_sync: Sending response to the blockchain: CrsGenResponse
        2024-11-07T14:41:09.871382Z  INFO send_result{tx_id=7087d7a61cbbd4dc0bbd1702107502bb9b88d00b}: kms_blockchain_connector::infrastructure::blockchain: Sending result to contract: ExecuteContractRequest { message: KmsMessage { txn_id: Some(TransactionId(HexVector([112, 135, 215, 166, 28, 187, 212, 220, 11, 189, 23, 2, 16, 117, 2, 187, 155, 136, 208, 11]))), value: CrsGenResponse(CrsGenResponseValues { request_id: "7087d7a61cbbd4dc0bbd1702107502bb9b88d00b", digest: "370d1b033f45014a3a546d111383d5f7b8ee5ec5", signature: HexVector([64, 0, 0, 0, ...44, 252]), max_num_bits: 2048, param: Default }) }, gas_limit: 3000000, funds: None }
    ```

    </details>

3. Run the fhevm coprocessor network (including a geth node).

    ```bash
    make run-coprocessor
    ```

   üìù At this step keys are not loaded in coprocessor DB.
   <details>
    <summary> üí° Why are we starting the coprocessor if keys are not available ? </summary>
  
    We have to do it to satisfy the gateway, gateway needs to conenct to the host BC node (geth here) in order to listen events.

    We need the gateway (1) to be able to call `\keyurl` endpoint in order to retrieve the identifiers associated to each keys (publicKey, serverKey, CRS ...).

    Then (2) we  download keys (with identifiers) from minio (S3 bucket like storage)
    </details>  

4. In a separate terminal, return to the same branch `v0.9.0-rc28` where the keys and crs have been generated.

    ```bash
    cd $path-to-kms-core
    cd blockchain/gateway
    ```

    üö® For **threshold mode** update the gateway config file (**config/gateway.toml**) with the following parameters:
    - mode = "threshold" (default is centralized)

    ```bash
    cargo run --bin gateway
    ```

    Wait for the gateway to start listening for blocks and print block numbers.

    ```bash
    ...
    2024-10-16T15:35:22.876765Z  INFO gateway::events::manager: üß± block number: 10
    2024-10-16T15:35:27.787809Z  INFO gateway::events::manager: üß± block number: 11
    ...
    ```

    <details>
    <summary> üí° Check the keys are ready by calling `\keyurl` endpoint </summary>
  
    ```bash
    curl  http://localhost:7077/keyurl
    ```

    </details>

### Centralized KMS

0. Verify the configuration in .env file, most important variable is CENTRALIZED_KMS, set it to true for threshold KMS

_Optionally_ you may update `KEY_GEN` value in `.env`. Default is `false`

| CENTRALIZED_KMS | Purpose |
| --- | --- |
| true    | KMS is running in centralized mode, keys are retrieved from the dev image (default) |
| false   | KMS is running in threshold mode with 4 MPC nodes, keys are freshly generated and signers are automatically updated |

1. Run the KMS in centralized mode (including the deployment of contracts on
   KMS blockchain).

    ```bash
    make run-kms
    ```

    <details>
    <summary> üí° Follow KMS blockchain smart contracts deployment ~ 2 mn </summary>
  
    ```bash
    docker logs zama-kms-threshold-dev-kms-blockchain-asc-deploy-1 -f  
    ```

    ```bash
          Summary of all the addresses:
      IPSC_ETHERMINT_ADDRESS : wasm1wug8sewp6cedgkmrmvhl3lf3tulagm9hnvy8p0rppz9yjw0g4wtqhs9hr8
      IPSC_ETHEREUM_ADDRESS : wasm1qg5ega6dykkxc307y25pecuufrjkxkaggkkxh7nad0vhyhtuhw3sq29c3m
      ASC_DEBUG_ADDRESS : wasm1yyca08xqdgvjz0psg56z67ejh9xms6l436u8y58m82npdqqhmmtqas0cl7
      ASC_ETHERMINT_ADDRESS : wasm1yw4xvtc43me9scqfr2jr2gzvcxd3a9y4eq7gaukreugw2yd2f8tsu3v7ad
      ASC_ETHEREUM_ADDRESS : wasm1cnuw3f076wgdyahssdkd0g3nr96ckq8cwa2mh029fn5mgf2fmcms9ax00l

      +++++++++++++++++++++++++++
      Contracts setups successful
      +++++++++++++++++++++++++++

    </details> 

2. Wait for key-gen and crs-gen to complete by following the logs.

    <details>
    <summary> üí° Follow key-gen and crs-gen logs </summary>
    ```bash
    docker logs zama-kms-gateway-dev-kms-simulator-keygen-1 -f
    ```
    ```bash
    Launching insecure key-gen
    [
      {
        "keygen_response": {
          "request_id": "b4ad0f97c2f361ba88fa16db3b492668b72e0c26",
          "public_key_digest": "92a5bf0a7b5196bafced38e89551f3069cf72ec5",
          "public_key_signature": "4000000000000000acff3f84b16ea5bbf7a05475b15c60bbb29cdc3446390f9d80e388639c4b6f8d147a888b890c9b9e22bceb8fd8a8bbab0ad1f72f04ab9a56a1f8fba6639b9fae",
          "server_key_digest": "1e965aec45abce284e1918eced0d4310360bdcc5",
          "server_key_signature": "4000000000000000afc45b19fa53b766dee8a801f975ec86d256cde26d30a38decf707a6438d1c6579d6d5b398c74806fdede4f6acf026a62bbde956df0e5160f621bea5837860b9",
          "param": "default"
        }
      }
    ]
    Launching crs-gen
    [
      {
        "crs_gen_response": {
          "request_id": "e2cf35682ae6eddafc939d50c8a901a2ef7f59d1",
          "digest": "2370672b6fee466a9073d3dcacd7553ab7e2cfd4",
          "signature": "40000000000000007203542c3ace4ae1d6cc2c02c3af5c2468316ee879c693b0a9819807ed4fb1fb0eb32a4bd8a2399df574f73fa8cbd561a58a81652972b4a7a549884bac8a3ae8",
          "max_num_bits": 2048,
          "param": "default"
        }
      }
    ]
    Success

    </details>

3. Run the fhevm coprocessor network (including a geth node).

    ```bash
    make run-coprocessor
    ```

   üìù At this step keys are not loaded in coprocessor DB.
   <details>
    <summary> üí° Why are we starting the coprocessor if keys are not available ? </summary>
  
    We have to do it to satisfy the gateway, gateway needs to conenct to the host BC node (geth here) in order to listen events.

    We need the gateway (1) to be able to call `\keyurl` endpoint in order to retrieve the identifiers associated to each keys (publicKey, serverKey, CRS ...).

    Then (2) we  download keys (with identifiers) from minio (S3 bucket like storage)
    </details>  

4. In a separate terminal, return to the same branch `v0.9.0-rc28` where the
   keys and crs have been generated.

    Here, first update the config file. Set `mode` to `centralized`. Then in
    `kms.public_storage`, set the first url to `http://localhost:9000/kms/PUB`
    and comment out the next 3 urls by prefixing with a `#`.

    ```bash
    cd $path-to-kms-core
    cd blockchain/gateway
    cargo run --bin gateway
    ```

    Wait for the gateway to start listening for blocks and print block numbers.

    ```bash
    ...
    2024-10-16T15:35:22.876765Z  INFO gateway::events::manager: üß± block number: 10
    2024-10-16T15:35:27.787809Z  INFO gateway::events::manager: üß± block number: 11
    ...
    ```

    <details>
    <summary> üí° Check the keys are ready by calling `\keyurl` endpoint </summary>
  
    ```bash
    curl  http://localhost:7077/keyurl
    ```

    </details>

## Steps setting up the environment (Part 2/2)

1. Retrieve the fhe keys and load them in coprocessor DB

    ```bash
    make init-db
    ```

    This command will make a call to `/keyurl` endpoint of gateway and retrieve the corresponding keys from the minio server.
    Then, keys will be copied into right folder in coprocessor and inserted in the DB

2. Clone the dependant repositories, if not already present.

    ```bash
    make check-all-test-repo
    ```

2. [Optional] Verify if the kms signer addresses is correctly configured.

   Value in `network-fhe-keys/signerN` should match
   `ADDRESS_KMS_SIGNER_N` in `work_dir/fhevm/.env.example.deployment`. If not
   update ENV file.

4. Fund test accounts and deploy the fhevm solidity contracts.

    ```bash
    make prepare-e2e-test
    ```

    If prompted to install npm dependencies, enter `y`.

5. From the fhevm repo, run one of the test for trivial decryption.

    ```bash
    cd work_dir/fhevm && npx hardhat test --grep 'test aasync decryptsync decrypt uint32$'
    ```

6. To tear down the setup, stop the docker containers:

    ```
    make stop-coprocessor
    make stop-kms
    ```

    The gateway will automatically exit as the connection will be closed from blockchain side.

## Note on test results (for trivial decrypt)

Note: If one of the non-trivial or re-encrypt tests fails, it should succeed
after a retry..

1. PASSING TESTS - All tests for trivial decrypt should now pass.

    ```bash
    npx hardhat test --grep 'test async decrypt bool$'
    npx hardhat test --grep 'test async decrypt uint4$'
    npx hardhat test --grep 'test async decrypt uint8$'
    npx hardhat test --grep 'test async decrypt uint16$'
    npx hardhat test --grep 'test async decrypt uint32$'
    npx hardhat test --grep 'test async decrypt uint64$'
    npx hardhat test --grep 'test async decrypt uint128$'
    npx hardhat test --grep 'test async decrypt uint256$'
    npx hardhat test --grep 'test async decrypt address$'
    npx hardhat test --grep 'test async decrypt mixed$'
    ```

2. PASSING TESTS - All tests for trivial reencrypt should now pass.

    ```bash
    npx hardhat test --grep 'test reencrypt bool$'
    npx hardhat test --grep 'test reencrypt uint4$'
    npx hardhat test --grep 'test reencrypt uint8$'
    npx hardhat test --grep 'test reencrypt uint16$'
    npx hardhat test --grep 'test reencrypt uint32$'
    npx hardhat test --grep 'test reencrypt uint64$'
    npx hardhat test --grep 'test reencrypt uint128$'
    npx hardhat test --grep 'test reencrypt uint256$'
    npx hardhat test --grep 'test reencrypt address$'

3. PASSING TEST - Non trivial decrypt with input mechanism

    ```bash
    npx hardhat test --grep 'test async decrypt uint64 non-trivial'
    ```

4. PASSING TEST - Non trivial reencrypt with input mechanism and fhe computation.

    ```bash
    npx hardhat test --grep 'test async decrypt addition uint64 non-trivial bigger value'
    ```

## Some issues you can encounter

  <details>
  <summary> üí° Unable to delete a docker network, example at `make clean` step  </summary>
    ```bash
    failed to remove network zama-kms-threshold_default: Error response from daemon: error while removing network: network zama-kms-threshold_default id 7f9cb8a4b1107a6c53663c4f5e513f6008bc227122ff64693576c8a686aaeae8 has active endpoints
    ```

    First try to docker prune the networks

    ```bash
    docker network prune

    # Check networks
    docker network ls | grep zama                                                                             
    4f43b8c0143b   zama-kms-threshold_default   bridge    local
    ```

    If the network is still here, just restart the docker deamon:

    ```bash
    # Linux-based OS
    sudo service docker restart
    docker network prune
    ```
  </details>
